{
  "files": [
    {
      "content": "import { cre, ok, consensusIdenticalAggregation, getNetwork, bytesToHex, Runner, type Runtime, type HTTPSendRequester, EVMLog } from \"@chainlink/cre-sdk\";\nimport { keccak256, toHex, encodeFunctionData, decodeEventLog, parseAbi } from \"viem\";\n\ntype Config = Record<string, never>;\n\nconst fetch_http_1 = (sendRequester: HTTPSendRequester, config: Config) => {\n  const req = {\n    url: \"https://api.example.com/validate\",\n    method: \"POST\" as const,\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    body: Buffer.from(new TextEncoder().encode(JSON.stringify(`{\"address\":\"${step_trigger_1.to}\",\"balance\":\"${step_evm_read_1.balance}\"}`))).toString(\"base64\"),\n  };\n\n  const resp = sendRequester.sendRequest(req).result();\n\n  if (!ok(resp)) {\n    throw new Error(`HTTP request failed with status: ${resp.statusCode}`);\n  }\n\n  return { statusCode: resp.statusCode, body: resp.body, headers: resp.headers };\n};\n\nconst onLogTrigger = (runtime: Runtime<Config>, triggerData: EVMLog): string => {\n  const httpClient = new cre.capabilities.HTTPClient();\n  const evmClient_base_testnet_sepolia = new cre.capabilities.EVMClient(getNetwork({ chainFamily: \"evm\", chainSelectorName: \"base-testnet-sepolia\", isTestnet: true })!.chainSelector.selector);\n\n  // Check Balance\n  const step_evm_read_1 = evmClient_ethereum_testnet_sepolia.read(runtime, {\n    contractAddress: \"0x1234567890abcdef1234567890abcdef12345678\",\n    functionName: \"balanceOf\",\n    abi: parseAbi([\"{\"type\":\"function\",\"name\":\"balanceOf\",\"inputs\":[{\"name\":\"account\",\"type\":\"address\",\"indexed\":null,\"components\":null}],\"outputs\":[{\"name\":\"balance\",\"type\":\"uint256\",\"indexed\":null,\"components\":null}],\"stateMutability\":\"view\"}\"]),\n    args: [step_trigger_1.to],\n  }).result();\n  // Validate User\n  const step_http_1 = httpClient.sendRequest(runtime, fetch_http_1, consensusIdenticalAggregation())(runtime.config).result();\n  // Parse Validation\n  const step_parse_1 = JSON.parse(Buffer.from(step_http_1.body, \"base64\").toString(\"utf-8\"));\n  // Is Valid?\n  if (step_parse_1.isValid === \"true\") {\n    // ABI encode mint call\n    const step_mint_1___encode = {\n      encoded: encodeFunctionData({\n        abi: [{\"name\":\"to\",\"type\":\"address\",\"indexed\":null,\"components\":null},{\"name\":\"amount\",\"type\":\"uint256\",\"indexed\":null,\"components\":null}],\n        args: [step_trigger_1.to, step_evm_read_1.balance],\n      }),\n    };\n    // Execute mint transaction\n    const step_mint_1___write = evmClient_base_testnet_sepolia.write(runtime, {\n      receiverAddress: \"0xabcdefabcdefabcdefabcdefabcdefabcdefabcd\",\n      gasLimit: BigInt(500000),\n      data: step_mint_1___encode.encoded,\n    }).result();\n    return \"\\\"Minted successfully\\\"\";\n  } else {\n    throw new Error(`User ${step_trigger_1.to} failed validation`);\n  }\n};\n\nconst initWorkflow = (config: Config) => {\n  const network = getNetwork({ chainFamily: \"evm\", chainSelectorName: \"ethereum-testnet-sepolia\", isTestnet: true });\n\n  if (!network) {\n    throw new Error(\"Network not found for chain selector\");\n  }\n\n  const evmClient = new cre.capabilities.EVMClient(network.chainSelector.selector);\n\n  const eventTopicHash = keccak256(toHex(\"Transfer(address,address,uint256)\"));\n\n  return [\n    cre.handler(\n      evmClient.logTrigger({\n        addresses: [\"0x1234567890abcdef1234567890abcdef12345678\"],\n        topics: [{ values: [eventTopicHash] }],\n        confidence: \"finalized\",\n      }),\n      onLogTrigger,\n    ),\n  ];\n};\n\nexport async function main() {\n  const runner = await Runner.newRunner<Config>();\n  await runner.run(initWorkflow);\n}\n\nmain();\n",
      "path": "main.ts"
    },
    {
      "content": "{\n\n}\n",
      "path": "config.staging.json"
    },
    {
      "content": "secretsNames:\n  VALIDATION_API_KEY:\n    - VALIDATION_API_KEY_VAR\n",
      "path": "secrets.yaml"
    },
    {
      "content": "staging-settings:\n  user-workflow:\n    workflow-name: \"evm-minting-pipeline-staging\"\n  workflow-artifacts:\n    workflow-path: \"./main.ts\"\n    config-path: \"./config.staging.json\"\n    secrets-path: \"../secrets.yaml\"\nproduction-settings:\n  user-workflow:\n    workflow-name: \"evm-minting-pipeline-production\"\n  workflow-artifacts:\n    workflow-path: \"./main.ts\"\n    config-path: \"./config.production.json\"\n    secrets-path: \"../secrets.yaml\"\n",
      "path": "workflow.yaml"
    },
    {
      "content": "staging-settings:\n  rpcs:\n    - chain-name: ethereum-testnet-sepolia\n      url: https://0xrpc.io/sep\n    - chain-name: base-testnet-sepolia\n      url: https://base-sepolia.drpc.org\n",
      "path": "project.yaml"
    },
    {
      "content": "{\n  \"name\": \"evm-minting-pipeline\",\n  \"version\": \"1.0.0\",\n  \"main\": \"dist/main.js\",\n  \"private\": true,\n  \"scripts\": {\n    \"postinstall\": \"bun x cre-setup\"\n  },\n  \"dependencies\": {\n    \"@chainlink/cre-sdk\": \"^1.0.9\",\n    \"zod\": \"^3.24\",\n    \"viem\": \"^2.0\"\n  },\n  \"devDependencies\": {\n    \"@types/bun\": \"1.2.21\"\n  }\n}\n",
      "path": "package.json"
    },
    {
      "content": "{\n  \"compilerOptions\": {\n    \"target\": \"ES2022\",\n    \"module\": \"ES2022\",\n    \"moduleResolution\": \"bundler\",\n    \"strict\": true,\n    \"esModuleInterop\": true,\n    \"skipLibCheck\": true,\n    \"forceConsistentCasingInFileNames\": true,\n    \"outDir\": \"./dist\",\n    \"rootDir\": \".\"\n  },\n  \"include\": [\"*.ts\"]\n}\n",
      "path": "tsconfig.json"
    },
    {
      "content": "# Environment variables for CRE simulation\n# Fill in real values before running `cre simulate`\n\nVALIDATION_API_KEY_VAR=<VALIDATION_API_KEY>\n",
      "path": ".env"
    }
  ],
  "status": "success",
  "warnings": [
    {
      "code": "E003",
      "message": "Step 'evm-read-1' references binding 'trigger-1' which is not in scope (not defined in a prior step or an ancestor block)"
    },
    {
      "code": "E003",
      "message": "Step 'http-1' references binding 'trigger-1' which is not in scope (not defined in a prior step or an ancestor block)"
    },
    {
      "code": "E003",
      "message": "Step 'mint-1___encode' references binding 'trigger-1' which is not in scope (not defined in a prior step or an ancestor block)"
    },
    {
      "code": "E003",
      "message": "Step 'error-1' references binding 'trigger-1' which is not in scope (not defined in a prior step or an ancestor block)"
    }
  ]
}